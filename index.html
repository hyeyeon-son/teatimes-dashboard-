<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìš°ë¦¬ ë™ë„¤ ì•„íŒŒíŠ¸ ì‹¤ê±°ë˜ê°€ ëŒ€ì‹œë³´ë“œ</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- PapaParse CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&display=swap');
        body { font-family: 'Pretendard', sans-serif; background-color: #f8fafc; }
        .stat-card { background: white; border-radius: 1rem; padding: 1.5rem; border: 1px solid #e2e8f0; transition: all 0.2s ease; }
        .stat-card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .table-container::-webkit-scrollbar { height: 8px; }
        .table-container::-webkit-scrollbar-track { background: #f1f5f9; }
        .table-container::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        
        /* ë³€ë™ë¥  ìŠ¤íƒ€ì¼ */
        .mom-up { color: #ef4444; font-size: 0.875rem; font-weight: 600; }
        .mom-down { color: #3b82f6; font-size: 0.875rem; font-weight: 600; }

        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal-overlay { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
    </style>
</head>
<body class="text-slate-800">

    <div class="max-w-7xl mx-auto px-4 py-8 lg:py-12">
        <!-- ëŒ€ì‹œë³´ë“œ í—¤ë” -->
        <header class="flex flex-col md:flex-row md:items-center justify-between mb-10 gap-6">
            <div>
                <h1 class="text-3xl md:text-4xl font-extrabold text-slate-900 tracking-tight">ìš°ë¦¬ ë™ë„¤ ì•„íŒŒíŠ¸ ì‹¤ê±°ë˜ê°€ ëŒ€ì‹œë³´ë“œ</h1>
                <p class="text-slate-500 mt-2 text-base md:text-lg">ì‹¤ì‹œê°„ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì „ì›” ëŒ€ë¹„ ë³€ë™ ì¶”ì´ë¥¼ ë¶„ì„í•©ë‹ˆë‹¤.</p>
            </div>
            <div id="status-container" class="flex items-center">
                <span id="status-badge" class="px-4 py-2 rounded-full text-xs md:text-sm font-semibold bg-blue-50 text-blue-600 border border-blue-100 animate-pulse whitespace-nowrap">
                    ë°ì´í„° ì†ŒìŠ¤ ì—°ê²° ì¤‘...
                </span>
            </div>
        </header>

        <!-- ìš”ì•½ í†µê³„ ì¹´ë“œ -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
            <div class="stat-card border-l-4 border-l-blue-500 flex justify-between items-start">
                <div>
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">ì „ì²´ ê±°ë˜ ê±´ìˆ˜</p>
                    <p id="total-count" class="text-3xl font-black text-slate-900">-</p>
                    <div id="total-mom" class="mt-2 h-5"></div>
                </div>
                <span class="text-3xl p-2 bg-blue-50 rounded-lg">ğŸ </span>
            </div>
            <div class="stat-card border-l-4 border-l-emerald-500 flex justify-between items-start">
                <div>
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">í‰ê·  ê±°ë˜ê°€ê²©</p>
                    <div class="flex items-baseline gap-1">
                        <p id="avg-price" class="text-3xl font-black text-slate-900">-</p>
                        <span class="text-sm font-medium text-slate-400">ë§Œì›</span>
                    </div>
                    <div id="avg-mom" class="mt-2 h-5"></div>
                </div>
                <span class="text-3xl p-2 bg-emerald-50 rounded-lg">ğŸ’°</span>
            </div>
            <div class="stat-card border-l-4 border-l-orange-500 flex justify-between items-start">
                <div>
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">ìµœê³  ê±°ë˜ê°€ê²©</p>
                    <div class="flex items-baseline gap-1">
                        <p id="max-price" class="text-3xl font-black text-slate-900">-</p>
                        <span class="text-sm font-medium text-slate-400">ë§Œì›</span>
                    </div>
                    <div id="max-mom" class="mt-2 h-5"></div>
                </div>
                <span class="text-3xl p-2 bg-orange-50 rounded-lg">ğŸ“ˆ</span>
            </div>
            <div class="stat-card border-l-4 border-l-rose-500 flex justify-between items-start">
                <div>
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">ìµœì € ê±°ë˜ê°€ê²©</p>
                    <div class="flex items-baseline gap-1">
                        <p id="min-price" class="text-3xl font-black text-slate-900">-</p>
                        <span class="text-sm font-medium text-slate-400">ë§Œì›</span>
                    </div>
                    <div id="min-mom" class="mt-2 h-5"></div>
                </div>
                <span class="text-3xl p-2 bg-rose-50 rounded-lg">ğŸ“‰</span>
            </div>
        </div>

        <!-- ë©”ì¸ ì°¨íŠ¸ ì„¹ì…˜ -->
        <div class="bg-white rounded-3xl p-6 md:p-10 shadow-sm border border-slate-100 mb-10">
            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-8 gap-4">
                <h2 class="text-xl md:text-2xl font-bold text-slate-900 flex items-center gap-3">
                    <span class="w-3 h-8 bg-blue-600 rounded-full"></span>
                    ì›”ë³„ í‰ê·  ê±°ë˜ê°€ê²© ì¶”ì´
                </h2>
                <p id="chart-subtitle" class="text-sm text-slate-400">ê±°ë˜ ì¼ì ê¸°ì¤€ ì›”ë³„ í‰ê· ê°€ (ë‹¨ìœ„: ë§Œì›)</p>
            </div>
            <div class="h-[300px] md:h-[400px] w-full">
                <canvas id="trendChart"></canvas>
            </div>
        </div>

        <!-- ì‹¤ê±°ë˜ ëª©ë¡ ì„¹ì…˜ -->
        <div class="bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden">
            <div class="px-8 py-6 border-b border-slate-50 flex items-center justify-between bg-slate-50/50">
                <div class="flex items-center gap-2">
                    <h2 class="text-lg md:text-xl font-bold text-slate-900">ìµœê·¼ ì‹¤ê±°ë˜ ëª©ë¡</h2>
                </div>
                <span id="data-count-badge" class="hidden sm:inline-block text-xs font-bold px-3 py-1 bg-slate-200 text-slate-600 rounded-full">ì—…ë°ì´íŠ¸ ëŒ€ê¸°</span>
            </div>

            <!-- ë°ìŠ¤í¬í†±ìš© í…Œì´ë¸” ë·° (md ì´ìƒì—ì„œë§Œ í‘œì‹œ) -->
            <div class="hidden md:block overflow-x-auto table-container">
                <table class="w-full text-left border-collapse min-w-[800px]">
                    <thead>
                        <tr class="text-slate-400 text-xs font-bold uppercase tracking-widest border-b border-slate-200 bg-slate-50/30">
                            <th class="px-8 py-5">ê±°ë˜ì¼ì</th>
                            <th class="px-8 py-5 text-slate-900">ì•„íŒŒíŠ¸ëª…</th>
                            <th class="px-8 py-5">ë²•ì •ë™</th>
                            <th class="px-8 py-5">ì „ìš©ë©´ì </th>
                            <th class="px-8 py-5">ì¸µ</th>
                            <th class="px-8 py-5 text-right text-slate-900 font-extrabold">ê±°ë˜ê¸ˆì•¡(ë§Œì›)</th>
                        </tr>
                    </thead>
                    <tbody id="data-table-body" class="divide-y divide-slate-100">
                        <tr>
                            <td colspan="6" class="px-8 py-24 text-center text-slate-400 italic font-medium">ë°ì´í„° ë¶„ì„ ì¤‘...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- ëª¨ë°”ì¼ìš© ë¦¬ìŠ¤íŠ¸ ë·° (md ë¯¸ë§Œì—ì„œë§Œ í‘œì‹œ) -->
            <div id="data-mobile-list" class="md:hidden divide-y divide-slate-100">
                <div class="p-8 text-center text-slate-400 italic">ë°ì´í„° ë¡œë”© ì¤‘...</div>
            </div>
        </div>
    </div>

    <!-- ìƒì„¸ ì •ë³´ ëª¨ë‹¬ -->
    <div id="detail-modal" class="fixed inset-0 z-[60] hidden">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm modal-overlay" onclick="closeModal()"></div>
        <div class="absolute inset-0 flex items-center justify-center p-4 pointer-events-none">
            <div class="bg-white w-full max-w-lg rounded-3xl shadow-2xl pointer-events-auto overflow-hidden modal-content translate-y-4 opacity-0">
                <div class="px-8 py-6 bg-slate-50 border-b border-slate-100 flex justify-between items-center">
                    <h3 class="text-xl font-bold text-slate-900">ì‹¤ê±°ë˜ ìƒì„¸ ì •ë³´</h3>
                    <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600 transition-colors p-1">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <div class="p-8 space-y-6">
                    <div id="modal-apartment-name" class="text-2xl font-black text-blue-600 mb-2">-</div>
                    <div class="grid grid-cols-2 gap-y-6 gap-x-4 text-sm md:text-base">
                        <div class="space-y-1">
                            <p class="text-xs font-bold text-slate-400 uppercase tracking-widest">ê±°ë˜ê¸ˆì•¡</p>
                            <p id="modal-price" class="text-lg font-black text-slate-900">-</p>
                        </div>
                        <div class="space-y-1">
                            <p class="text-xs font-bold text-slate-400 uppercase tracking-widest">ê±°ë˜ì¼ì</p>
                            <p id="modal-date" class="text-lg font-bold text-slate-900">-</p>
                        </div>
                        <div class="space-y-1 border-t border-slate-50 pt-4">
                            <p class="text-xs font-bold text-slate-400 uppercase tracking-widest">ë²•ì •ë™</p>
                            <p id="modal-dong" class="font-medium text-slate-700">-</p>
                        </div>
                        <div class="space-y-1 border-t border-slate-50 pt-4">
                            <p class="text-xs font-bold text-slate-400 uppercase tracking-widest">ì „ìš©ë©´ì </p>
                            <p id="modal-area" class="font-medium text-slate-700">-</p>
                        </div>
                        <div class="space-y-1 border-t border-slate-50 pt-4">
                            <p class="text-xs font-bold text-slate-400 uppercase tracking-widest">ì¸µ / ê±´ì¶•ë…„ë„</p>
                            <p id="modal-floor-year" class="font-medium text-slate-700">-</p>
                        </div>
                    </div>
                    <button onclick="closeModal()" class="w-full py-4 bg-slate-900 text-white rounded-2xl font-bold hover:bg-slate-800 transition-colors mt-4">í™•ì¸</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ì´ˆê¸° ë¡œë”© í™”ë©´ -->
    <div id="initial-loader" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="relative w-20 h-20 mb-8">
            <div class="absolute inset-0 border-4 border-blue-50 rounded-full"></div>
            <div class="absolute inset-0 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
        </div>
        <p class="text-slate-400 animate-pulse font-medium">ì‹¤ê±°ë˜ ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
    </div>

    <script>
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRSjs1b5A4Gpa4PtUU29bXQYvUEOEgbGEF8TqmuBY35Za7dsX-Td_nsavGZcxS-PDAmjmV_4EBJmck2/pub?gid=945303917&single=true&output=csv';

        let trendChart;

        function cleanNumber(val) {
            if (val === undefined || val === null) return 0;
            const str = String(val).replace(/[^0-9.]/g, '');
            return parseFloat(str) || 0;
        }

        function getValByHeader(row, targetName) {
            const keys = Object.keys(row);
            const normalize = (s) => s.replace(/[\s\(\)ã¡,]/g, '').toLowerCase();
            const targetNorm = normalize(targetName);
            const match = keys.find(k => {
                const kNorm = normalize(k);
                return kNorm.includes(targetNorm) || targetNorm.includes(kNorm);
            });
            return match ? row[match] : null;
        }

        function openModal(item) {
            const modal = document.getElementById('detail-modal');
            const content = modal.querySelector('.modal-content');
            
            const price = cleanNumber(getValByHeader(item, 'ê±°ë˜ê¸ˆì•¡'));
            document.getElementById('modal-apartment-name').innerText = getValByHeader(item, 'ì•„íŒŒíŠ¸ëª…') || '-';
            document.getElementById('modal-price').innerText = price.toLocaleString() + ' ë§Œì›';
            document.getElementById('modal-date').innerText = getValByHeader(item, 'ê±°ë˜ì¼ì') || '-';
            document.getElementById('modal-dong').innerText = getValByHeader(item, 'ë²•ì •ë™') || '-';
            document.getElementById('modal-area').innerText = (getValByHeader(item, 'ì „ìš©ë©´ì ') || '-') + ' ã¡';
            document.getElementById('modal-floor-year').innerText = `${getValByHeader(item, 'ì¸µ') || '-'}ì¸µ / ${getValByHeader(item, 'ê±´ì¶•ë…„ë„') || '-'}ë…„`;

            modal.classList.remove('hidden');
            setTimeout(() => content.classList.remove('translate-y-4', 'opacity-0'), 10);
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            const modal = document.getElementById('detail-modal');
            const content = modal.querySelector('.modal-content');
            content.classList.add('translate-y-4', 'opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
                document.body.style.overflow = '';
            }, 300);
        }

        function renderMom(elementId, current, previous) {
            const el = document.getElementById(elementId);
            if (!previous || previous === 0) {
                el.innerHTML = '<span class="text-slate-300 text-[11px]">ë¹„êµ ë°ì´í„° ì—†ìŒ</span>';
                return;
            }
            const diff = ((current - previous) / previous) * 100;
            const absDiff = Math.abs(diff).toFixed(1);
            
            if (diff > 0) el.innerHTML = `<span class="mom-up">â–² ${absDiff}%</span> <span class="text-[11px] text-slate-400 ml-1 font-normal">ì „ì›” ëŒ€ë¹„</span>`;
            else if (diff < 0) el.innerHTML = `<span class="mom-down">â–¼ ${absDiff}%</span> <span class="text-[11px] text-slate-400 ml-1 font-normal">ì „ì›” ëŒ€ë¹„</span>`;
            else el.innerHTML = `<span class="text-slate-400 text-[11px]">ë³€ë™ ì—†ìŒ</span>`;
        }

        function renderDashboard(data) {
            if (!data || data.length === 0) return;

            const prices = data.map(row => cleanNumber(getValByHeader(row, 'ê±°ë˜ê¸ˆì•¡'))).filter(p => p > 0);
            
            // í†µê³„ ê³„ì‚°
            const monthlyStats = {};
            data.forEach(row => {
                const dateRaw = String(getValByHeader(row, 'ê±°ë˜ì¼ì') || '');
                if (dateRaw.length >= 7) {
                    const month = dateRaw.substring(0, 7); 
                    const price = cleanNumber(getValByHeader(row, 'ê±°ë˜ê¸ˆì•¡'));
                    if (price > 0) {
                        if (!monthlyStats[month]) monthlyStats[month] = { sum: 0, count: 0, max: 0, min: Infinity };
                        monthlyStats[month].sum += price;
                        monthlyStats[month].count += 1;
                        monthlyStats[month].max = Math.max(monthlyStats[month].max, price);
                        monthlyStats[month].min = Math.min(monthlyStats[month].min, price);
                    }
                }
            });

            const months = Object.keys(monthlyStats).sort();
            const currentData = monthlyStats[months[months.length - 1]];
            const prevData = months.length > 1 ? monthlyStats[months[months.length - 2]] : null;

            document.getElementById('total-count').innerText = data.length.toLocaleString() + ' ê±´';
            document.getElementById('avg-price').innerText = Math.round(prices.reduce((a, b) => a + b, 0) / prices.length).toLocaleString();
            document.getElementById('max-price').innerText = Math.max(...prices).toLocaleString();
            document.getElementById('min-price').innerText = Math.min(...prices).toLocaleString();
            document.getElementById('data-count-badge').innerText = `ì´ ${data.length}ê°œì˜ ê¸°ë¡`;

            renderMom('total-mom', currentData.count, prevData ? prevData.count : 0);
            renderMom('avg-mom', currentData.sum / currentData.count, prevData ? prevData.sum / prevData.count : 0);
            renderMom('max-mom', currentData.max, prevData ? prevData.max : 0);
            renderMom('min-mom', currentData.min, prevData ? prevData.min : 0);

            // ëª©ë¡ ë Œë”ë§ (ë°ìŠ¤í¬í†± & ëª¨ë°”ì¼)
            const tableBody = document.getElementById('data-table-body');
            const mobileList = document.getElementById('data-mobile-list');
            tableBody.innerHTML = '';
            mobileList.innerHTML = '';

            const sortedData = [...data].sort((a, b) => new Date(getValByHeader(b, 'ê±°ë˜ì¼ì')) - new Date(getValByHeader(a, 'ê±°ë˜ì¼ì')));

            sortedData.forEach((row, index) => {
                const price = cleanNumber(getValByHeader(row, 'ê±°ë˜ê¸ˆì•¡'));
                const name = getValByHeader(row, 'ì•„íŒŒíŠ¸ëª…') || '-';
                const date = getValByHeader(row, 'ê±°ë˜ì¼ì') || '-';
                const isHighPrice = price >= 50000;
                const priceColor = isHighPrice ? 'text-red-600' : 'text-blue-600';

                // Desktop Row
                const tr = document.createElement('tr');
                tr.className = `transition-colors cursor-pointer hover:bg-blue-50/50 ${index % 2 === 0 ? 'bg-white' : 'bg-slate-50/30'}`;
                tr.onclick = () => openModal(row);
                tr.innerHTML = `
                    <td class="px-8 py-5 text-slate-500 font-medium">${date}</td>
                    <td class="px-8 py-5 font-bold text-slate-900">${name}</td>
                    <td class="px-8 py-5 text-slate-500">${getValByHeader(row, 'ë²•ì •ë™') || '-'}</td>
                    <td class="px-8 py-5 text-slate-400 font-mono text-xs">${getValByHeader(row, 'ì „ìš©ë©´ì ') || '-'}ã¡</td>
                    <td class="px-8 py-5 text-slate-400">${getValByHeader(row, 'ì¸µ') || '-'}F</td>
                    <td class="px-8 py-5 text-right text-base font-black ${priceColor}">${price.toLocaleString()}</td>
                `;
                tableBody.appendChild(tr);

                // Mobile Card
                const card = document.createElement('div');
                card.className = 'p-6 active:bg-slate-100 cursor-pointer transition-colors flex flex-col gap-2';
                card.onclick = () => openModal(row);
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <h4 class="font-bold text-slate-900 text-base leading-tight flex-1 mr-4">${name}</h4>
                        <span class="text-lg font-black shrink-0 ${priceColor}">${price.toLocaleString()}</span>
                    </div>
                    <div class="flex justify-between items-end text-xs text-slate-400">
                        <div class="space-y-1">
                            <p>${getValByHeader(row, 'ë²•ì •ë™') || '-'} Â· ${getValByHeader(row, 'ì „ìš©ë©´ì ') || '-'}ã¡ Â· ${getValByHeader(row, 'ì¸µ') || '-'}F</p>
                            <p class="font-medium text-slate-500">${date}</p>
                        </div>
                        <span class="px-2 py-1 bg-slate-100 rounded text-[10px] font-bold uppercase tracking-wider">ìƒì„¸ë³´ê¸°</span>
                    </div>
                `;
                mobileList.appendChild(card);
            });

            const labels = months;
            const chartValues = months.map(m => Math.round(monthlyStats[m].sum / monthlyStats[m].count));
            updateTrendChart(labels, chartValues);
        }

        function updateTrendChart(labels, values) {
            const ctx = document.getElementById('trendChart').getContext('2d');
            if (trendChart) trendChart.destroy();
            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'í‰ê·  ê±°ë˜ê°€',
                        data: values,
                        borderColor: '#2563eb',
                        backgroundColor: 'rgba(59, 130, 246, 0.05)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 5,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#2563eb'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { display: false }, ticks: { font: { size: 10 } } },
                        y: { 
                            grid: { borderDash: [5, 5], color: '#f1f5f9' },
                            ticks: { callback: (v) => v.toLocaleString(), font: { size: 10 } } 
                        }
                    }
                }
            });
        }

        async function loadData() {
            try {
                const response = await fetch(`${CSV_URL}&t=${Date.now()}`);
                const csvString = await response.text();
                Papa.parse(csvString, {
                    header: true,
                    skipEmptyLines: 'greedy',
                    complete: function(results) {
                        if (results.data && results.data.length > 0) {
                            renderDashboard(results.data);
                            const loader = document.getElementById('initial-loader');
                            loader.style.opacity = '0';
                            setTimeout(() => loader.style.display = 'none', 500);
                            const badge = document.getElementById('status-badge');
                            badge.innerText = 'ì‹¤ì‹œê°„ ì—°ê²°ë¨';
                            badge.className = 'px-4 py-2 rounded-full text-xs md:text-sm font-semibold bg-emerald-50 text-emerald-600 border border-emerald-100 animate-none';
                        }
                    }
                });
            } catch (err) {
                console.error(err);
            }
        }

        window.onload = loadData;
    </script>
</body>
</html>
