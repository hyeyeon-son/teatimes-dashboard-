<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìš°ë¦¬ ë™ë„¤ ì•„íŒŒíŠ¸ ì‹¤ê±°ë˜ê°€ ëŒ€ì‹œë³´ë“œ</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- PapaParse CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&display=swap');
        body { font-family: 'Pretendard', sans-serif; background-color: #f8fafc; }
        .stat-card { background: white; border-radius: 1rem; padding: 1.5rem; border: 1px solid #e2e8f0; transition: all 0.2s ease; }
        .stat-card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .table-container::-webkit-scrollbar { height: 8px; }
        .table-container::-webkit-scrollbar-track { background: #f1f5f9; }
        .table-container::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        
        /* ë³€ë™ë¥  ì• ë‹ˆë©”ì´ì…˜ ë° ìŠ¤íƒ€ì¼ */
        .mom-up { color: #ef4444; font-size: 0.875rem; font-weight: 600; }
        .mom-down { color: #3b82f6; font-size: 0.875rem; font-weight: 600; }
    </style>
</head>
<body class="text-slate-800">

    <div class="max-w-7xl mx-auto px-4 py-8 lg:py-12">
        <!-- ëŒ€ì‹œë³´ë“œ í—¤ë” -->
        <header class="flex flex-col md:flex-row md:items-center justify-between mb-10 gap-6">
            <div>
                <h1 class="text-3xl md:text-4xl font-extrabold text-slate-900 tracking-tight">ìš°ë¦¬ ë™ë„¤ ì•„íŒŒíŠ¸ ì‹¤ê±°ë˜ê°€ ëŒ€ì‹œë³´ë“œ</h1>
                <p class="text-slate-500 mt-2 text-base md:text-lg">ì‹¤ì‹œê°„ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì „ì›” ëŒ€ë¹„ ë³€ë™ ì¶”ì´ë¥¼ ë¶„ì„í•©ë‹ˆë‹¤.</p>
            </div>
            <div id="status-container" class="flex items-center">
                <span id="status-badge" class="px-4 py-2 rounded-full text-xs md:text-sm font-semibold bg-blue-50 text-blue-600 border border-blue-100 animate-pulse whitespace-nowrap">
                    ë°ì´í„° ì†ŒìŠ¤ ì—°ê²° ì¤‘...
                </span>
            </div>
        </header>

        <!-- ì—ëŸ¬ ì•Œë¦¼ ì˜ì—­ -->
        <div id="error-banner" class="hidden mb-8 p-6 bg-rose-50 border-2 border-rose-200 rounded-2xl text-rose-800">
            <div class="flex items-center mb-3">
                <svg class="w-6 h-6 mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                <h3 class="font-bold text-lg">ë°ì´í„° ë¶„ì„ ì‹¤íŒ¨</h3>
            </div>
            <p id="error-message" class="text-sm opacity-90 leading-relaxed"></p>
        </div>

        <!-- ìš”ì•½ í†µê³„ ì¹´ë“œ (ë°˜ì‘í˜•: 1ì—´ -> 2ì—´ -> 4ì—´) -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
            <!-- ì „ì²´ ê±°ë˜ ê±´ìˆ˜ -->
            <div class="stat-card border-l-4 border-l-blue-500 flex justify-between items-start">
                <div>
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">ì „ì²´ ê±°ë˜ ê±´ìˆ˜</p>
                    <p id="total-count" class="text-3xl font-black text-slate-900">-</p>
                    <div id="total-mom" class="mt-2 h-5"></div>
                </div>
                <span class="text-3xl p-2 bg-blue-50 rounded-lg">ğŸ </span>
            </div>
            <!-- í‰ê·  ê±°ë˜ê°€ê²© -->
            <div class="stat-card border-l-4 border-l-emerald-500 flex justify-between items-start">
                <div>
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">í‰ê·  ê±°ë˜ê°€ê²©</p>
                    <div class="flex items-baseline gap-1">
                        <p id="avg-price" class="text-3xl font-black text-slate-900">-</p>
                        <span class="text-sm font-medium text-slate-400">ë§Œì›</span>
                    </div>
                    <div id="avg-mom" class="mt-2 h-5"></div>
                </div>
                <span class="text-3xl p-2 bg-emerald-50 rounded-lg">ğŸ’°</span>
            </div>
            <!-- ìµœê³  ê±°ë˜ê°€ê²© -->
            <div class="stat-card border-l-4 border-l-orange-500 flex justify-between items-start">
                <div>
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">ìµœê³  ê±°ë˜ê°€ê²©</p>
                    <div class="flex items-baseline gap-1">
                        <p id="max-price" class="text-3xl font-black text-slate-900">-</p>
                        <span class="text-sm font-medium text-slate-400">ë§Œì›</span>
                    </div>
                    <div id="max-mom" class="mt-2 h-5"></div>
                </div>
                <span class="text-3xl p-2 bg-orange-50 rounded-lg">ğŸ“ˆ</span>
            </div>
            <!-- ìµœì € ê±°ë˜ê°€ê²© -->
            <div class="stat-card border-l-4 border-l-rose-500 flex justify-between items-start">
                <div>
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">ìµœì € ê±°ë˜ê°€ê²©</p>
                    <div class="flex items-baseline gap-1">
                        <p id="min-price" class="text-3xl font-black text-slate-900">-</p>
                        <span class="text-sm font-medium text-slate-400">ë§Œì›</span>
                    </div>
                    <div id="min-mom" class="mt-2 h-5"></div>
                </div>
                <span class="text-3xl p-2 bg-rose-50 rounded-lg">ğŸ“‰</span>
            </div>
        </div>

        <!-- ë©”ì¸ ì°¨íŠ¸ ì„¹ì…˜ -->
        <div class="bg-white rounded-3xl p-6 md:p-10 shadow-sm border border-slate-100 mb-10">
            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-8 gap-4">
                <h2 class="text-xl md:text-2xl font-bold text-slate-900 flex items-center gap-3">
                    <span class="w-3 h-8 bg-blue-600 rounded-full"></span>
                    ì›”ë³„ í‰ê·  ê±°ë˜ê°€ê²© ì¶”ì´
                </h2>
                <p id="chart-subtitle" class="text-sm text-slate-400">ê±°ë˜ ì¼ì ê¸°ì¤€ ì›”ë³„ í‰ê· ê°€ (ë‹¨ìœ„: ë§Œì›)</p>
            </div>
            <div class="h-[300px] md:h-[400px] w-full">
                <canvas id="trendChart"></canvas>
            </div>
        </div>

        <!-- ìƒì„¸ í…Œì´ë¸” ì„¹ì…˜ -->
        <div class="bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden text-sm">
            <div class="px-8 py-6 border-b border-slate-50 flex items-center justify-between bg-slate-50/50">
                <h2 class="text-lg md:text-xl font-bold text-slate-900">ìµœê·¼ ì‹¤ê±°ë˜ ëª©ë¡</h2>
                <span id="data-count-badge" class="hidden sm:inline-block text-xs font-bold px-3 py-1 bg-slate-200 text-slate-600 rounded-full text-center">ì—…ë°ì´íŠ¸ ëŒ€ê¸°</span>
            </div>
            <div class="overflow-x-auto table-container">
                <table class="w-full text-left border-collapse min-w-[800px]">
                    <thead>
                        <tr class="text-slate-400 text-xs font-bold uppercase tracking-widest border-b border-slate-200 bg-slate-50/30">
                            <th class="px-8 py-5">ê±°ë˜ì¼ì</th>
                            <th class="px-8 py-5 text-slate-900">ì•„íŒŒíŠ¸ëª…</th>
                            <th class="px-8 py-5">ë²•ì •ë™</th>
                            <th class="px-8 py-5">ì „ìš©ë©´ì </th>
                            <th class="px-8 py-5">ì¸µ</th>
                            <th class="px-8 py-5">ê±´ì¶•ë…„ë„</th>
                            <th class="px-8 py-5 text-right text-slate-900 font-extrabold">ê±°ë˜ê¸ˆì•¡(ë§Œì›)</th>
                        </tr>
                    </thead>
                    <tbody id="data-table-body" class="divide-y divide-slate-100">
                        <tr>
                            <td colspan="7" class="px-8 py-24 text-center">
                                <p class="text-slate-400 font-medium italic">ë°ì´í„°ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ì´ˆê¸° ë¡œë”© í™”ë©´ -->
    <div id="initial-loader" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="relative w-20 h-20 mb-8">
            <div class="absolute inset-0 border-4 border-blue-50 rounded-full"></div>
            <div class="absolute inset-0 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
        </div>
        <p class="text-slate-400 animate-pulse font-medium">ì‹¤ê±°ë˜ ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
    </div>

    <script>
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRSjs1b5A4Gpa4PtUU29bXQYvUEOEgbGEF8TqmuBY35Za7dsX-Td_nsavGZcxS-PDAmjmV_4EBJmck2/pub?gid=945303917&single=true&output=csv';

        let trendChart;

        function cleanNumber(val) {
            if (val === undefined || val === null) return 0;
            const str = String(val).replace(/[^0-9.]/g, '');
            return parseFloat(str) || 0;
        }

        function getValByHeader(row, targetName) {
            const keys = Object.keys(row);
            const normalize = (s) => s.replace(/[\s\(\)ã¡,]/g, '').toLowerCase();
            const targetNorm = normalize(targetName);
            const match = keys.find(k => {
                const kNorm = normalize(k);
                return kNorm.includes(targetNorm) || targetNorm.includes(kNorm);
            });
            return match ? row[match] : null;
        }

        /**
         * ë³€ë™ë¥  ë Œë”ë§ ìœ í‹¸ë¦¬í‹°
         */
        function renderMom(elementId, current, previous) {
            const el = document.getElementById(elementId);
            if (!previous || previous === 0) {
                el.innerHTML = '<span class="text-slate-300 text-[11px]">ë¹„êµ ë°ì´í„° ì—†ìŒ</span>';
                return;
            }
            const diff = ((current - previous) / previous) * 100;
            const absDiff = Math.abs(diff).toFixed(1);
            
            if (diff > 0) {
                el.innerHTML = `<span class="mom-up">â–² ${absDiff}%</span> <span class="text-[11px] text-slate-400 ml-1 font-normal">ì „ì›” ëŒ€ë¹„</span>`;
            } else if (diff < 0) {
                el.innerHTML = `<span class="mom-down">â–¼ ${absDiff}%</span> <span class="text-[11px] text-slate-400 ml-1 font-normal">ì „ì›” ëŒ€ë¹„</span>`;
            } else {
                el.innerHTML = `<span class="text-slate-400 text-[11px]">ë³€ë™ ì—†ìŒ</span>`;
            }
        }

        function renderDashboard(data) {
            if (!data || data.length === 0) return;

            const prices = data.map(row => cleanNumber(getValByHeader(row, 'ê±°ë˜ê¸ˆì•¡'))).filter(p => p > 0);
            if (prices.length === 0) {
                showErrorMessage("'ê±°ë˜ê¸ˆì•¡' ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            // 1. ì›”ë³„ í†µê³„ ê³„ì‚° (MoMìš©)
            const monthlyStats = {};
            data.forEach(row => {
                const dateRaw = String(getValByHeader(row, 'ê±°ë˜ì¼ì') || '');
                if (dateRaw.length >= 7) {
                    const month = dateRaw.substring(0, 7); 
                    const price = cleanNumber(getValByHeader(row, 'ê±°ë˜ê¸ˆì•¡'));
                    if (price > 0) {
                        if (!monthlyStats[month]) monthlyStats[month] = { sum: 0, count: 0, max: 0, min: Infinity };
                        monthlyStats[month].sum += price;
                        monthlyStats[month].count += 1;
                        monthlyStats[month].max = Math.max(monthlyStats[month].max, price);
                        monthlyStats[month].min = Math.min(monthlyStats[month].min, price);
                    }
                }
            });

            const months = Object.keys(monthlyStats).sort();
            const currentMonth = months[months.length - 1];
            const prevMonth = months[months.length - 2];

            const currentData = monthlyStats[currentMonth];
            const prevData = prevMonth ? monthlyStats[prevMonth] : null;

            // 2. ìš”ì•½ ì •ë³´ ë° MoM í‘œì‹œ
            const totalAvg = Math.round(prices.reduce((a, b) => a + b, 0) / prices.length);
            const totalMax = Math.max(...prices);
            const totalMin = Math.min(...prices).toLocaleString();

            document.getElementById('total-count').innerText = data.length.toLocaleString() + ' ê±´';
            document.getElementById('avg-price').innerText = totalAvg.toLocaleString();
            document.getElementById('max-price').innerText = totalMax.toLocaleString();
            document.getElementById('min-price').innerText = totalMin;
            document.getElementById('data-count-badge').innerText = `ì´ ${data.length}ê°œì˜ ê¸°ë¡`;

            // MoM ë Œë”ë§
            renderMom('total-mom', currentData.count, prevData ? prevData.count : 0);
            renderMom('avg-mom', currentData.sum / currentData.count, prevData ? prevData.sum / prevData.count : 0);
            renderMom('max-mom', currentData.max, prevData ? prevData.max : 0);
            renderMom('min-mom', currentData.min, prevData ? prevData.min : 0);

            // 3. í…Œì´ë¸” ë Œë”ë§
            const tableBody = document.getElementById('data-table-body');
            tableBody.innerHTML = '';
            const sortedData = [...data].sort((a, b) => new Date(getValByHeader(b, 'ê±°ë˜ì¼ì')) - new Date(getValByHeader(a, 'ê±°ë˜ì¼ì')));

            sortedData.forEach((row, index) => {
                const price = cleanNumber(getValByHeader(row, 'ê±°ë˜ê¸ˆì•¡'));
                const isHighPrice = price >= 50000;
                const tr = document.createElement('tr');
                tr.className = `transition-colors hover:bg-blue-50/50 ${index % 2 === 0 ? 'bg-white' : 'bg-slate-50/30'}`;
                tr.innerHTML = `
                    <td class="px-8 py-5 text-slate-500 font-medium">${getValByHeader(row, 'ê±°ë˜ì¼ì') || '-'}</td>
                    <td class="px-8 py-5 font-bold text-slate-900">${getValByHeader(row, 'ì•„íŒŒíŠ¸ëª…') || '-'}</td>
                    <td class="px-8 py-5 text-slate-500">${getValByHeader(row, 'ë²•ì •ë™') || '-'}</td>
                    <td class="px-8 py-5 text-slate-400 font-mono text-xs">${getValByHeader(row, 'ì „ìš©ë©´ì ') || '-'}ã¡</td>
                    <td class="px-8 py-5 text-slate-400 text-center">${getValByHeader(row, 'ì¸µ') || '-'}F</td>
                    <td class="px-8 py-5 text-slate-400 text-center">${getValByHeader(row, 'ê±´ì¶•ë…„ë„') || '-'}</td>
                    <td class="px-8 py-5 text-right text-base ${isHighPrice ? 'text-red-600 font-extrabold' : 'text-blue-600 font-black'}">${price.toLocaleString()}</td>
                `;
                tableBody.appendChild(tr);
            });

            // 4. ì°¨íŠ¸ ì—…ë°ì´íŠ¸
            const labels = months;
            const chartValues = months.map(m => Math.round(monthlyStats[m].sum / monthlyStats[m].count));
            updateTrendChart(labels, chartValues);
        }

        function updateTrendChart(labels, values) {
            const ctx = document.getElementById('trendChart').getContext('2d');
            if (trendChart) trendChart.destroy();
            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'í‰ê·  ê±°ë˜ê°€',
                        data: values,
                        borderColor: '#2563eb',
                        backgroundColor: 'rgba(59, 130, 246, 0.05)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 5,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#2563eb'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { display: false } },
                        y: { 
                            grid: { borderDash: [5, 5], color: '#f1f5f9' },
                            ticks: { callback: (v) => v.toLocaleString() } 
                        }
                    }
                }
            });
        }

        function showErrorMessage(msg) {
            document.getElementById('initial-loader').style.display = 'none';
            document.getElementById('error-banner').classList.remove('hidden');
            document.getElementById('error-message').innerText = msg;
            const badge = document.getElementById('status-badge');
            badge.innerText = 'ì—°ê²° ì˜¤ë¥˜';
            badge.className = 'px-4 py-2 rounded-full text-sm font-semibold bg-rose-50 text-rose-600 border border-rose-100';
        }

        async function loadData() {
            try {
                const response = await fetch(`${CSV_URL}&t=${Date.now()}`);
                if (!response.ok) throw new Error('ë°ì´í„° ì†ŒìŠ¤ ì‘ë‹µ ì‹¤íŒ¨');
                const csvString = await response.text();
                Papa.parse(csvString, {
                    header: true,
                    skipEmptyLines: 'greedy',
                    complete: function(results) {
                        if (results.data && results.data.length > 0) {
                            renderDashboard(results.data);
                            const loader = document.getElementById('initial-loader');
                            loader.style.opacity = '0';
                            setTimeout(() => loader.style.display = 'none', 500);
                            const badge = document.getElementById('status-badge');
                            badge.innerText = 'ì‹¤ì‹œê°„ ì—°ê²°ë¨';
                            badge.className = 'px-4 py-2 rounded-full text-xs md:text-sm font-semibold bg-emerald-50 text-emerald-600 border border-emerald-100 animate-none';
                        } else {
                            throw new Error('ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                        }
                    }
                });
            } catch (err) {
                showErrorMessage(err.message);
            }
        }

        window.onload = loadData;
    </script>
</body>
</html>
